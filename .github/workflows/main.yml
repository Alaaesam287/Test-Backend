name: Security Scans
on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:
permissions:
  contents: read
  security-events: write
jobs:
  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: stable
          cache: true
      - name: Create sarif output directory
        run: mkdir -p sarif
      # â”€â”€ gosec â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Run gosec
        continue-on-error: true
        id: gosec
        run: |
          go install github.com/securego/gosec/v2/cmd/gosec@latest
          # Run gosec for JSON output
          gosec -fmt=json -out=sarif/gosec.json ./... || true
          # Run gosec for SARIF output
          gosec -fmt=sarif -out=sarif/gosec.sarif ./... || true
          # Count issues
          ISSUES=$(jq '.Issues | length' sarif/gosec.json 2>/dev/null || echo "0")
          echo "issues=${ISSUES}" >> $GITHUB_OUTPUT
      # â”€â”€ govulncheck â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Run govulncheck
        continue-on-error: true
        id: govulncheck
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          # Run for SARIF
          govulncheck -format sarif ./... 2>&1 | tee sarif/govulncheck.sarif || true
          # Run for JSON
          govulncheck -format json ./... 2>&1 | tee sarif/govulncheck.json || true
          # Count vulnerabilities - govulncheck JSON has different structure
          VULNS=$(jq -r 'select(.finding != null) | .finding' sarif/govulncheck.json 2>/dev/null | wc -l || echo "0")
          echo "vulns=${VULNS}" >> $GITHUB_OUTPUT
      # â”€â”€ Upload to Security tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Upload SARIF results
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: sarif/
          category: security-scans
      # â”€â”€ Job summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Create job summary
        if: always()
        run: |
          GOSEC_ISSUES=$(jq '.Issues | length' sarif/gosec.json 2>/dev/null || echo "0")
          GOVULNCHECK_VULNS=$(jq -r 'select(.finding != null) | .finding' sarif/govulncheck.json 2>/dev/null | wc -l || echo "0")
          
          {
            echo "## ðŸ”’ Security Scan Results"
            echo ""
            echo "- **gosec**: ${GOSEC_ISSUES} issues"
            echo "- **govulncheck**: ${GOVULNCHECK_VULNS} vulnerabilities"
            echo ""
            echo "Details â†’ Security â†’ Code scanning tab"
            echo ""
            echo "Full JSON reports â†’ Artifacts (security-reports)"
          } >> $GITHUB_STEP_SUMMARY
      # â”€â”€ Artifacts (only JSON + SARIF for debugging/review) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Upload reports as artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            sarif/*.json
            sarif/*.sarif
          retention-days: 14
      # â”€â”€ Block if issues found (skip on manual dispatch) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Fail if security issues found
        if: |
          github.event_name != 'workflow_dispatch' &&
          (steps.gosec.outputs.issues != '0' || steps.govulncheck.outputs.vulns != '0')
        run: |
          echo "::error::Security issues found in gosec or govulncheck."
          echo "â†’ Review in Security â†’ Code scanning"
          echo "â†’ Download artifacts for JSON/SARIF details"
          exit 1

name: Security Scans

on:
  workflow_dispatch:
  pull_request:
    branches: ['**']
  push:
    branches: [main]

permissions:
  contents: read
  security-events: write

jobs:
  security-scans:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'
          cache: true

      # ========================
      # GOSEC
      # ========================
      - name: Install gosec
        run: go install github.com/securego/gosec/v2/cmd/gosec@latest

      - name: Run gosec
        id: gosec
        continue-on-error: true  
        run: |
          echo "=== Checking gosec installation ==="
          which gosec || echo "gosec not found in PATH"
          
          echo "=== Adding gosec to PATH ==="
          export PATH=$PATH:$(go env GOPATH)/bin
          which gosec
          
          echo "=== Checking for Go files ==="
          find . -name "*.go" -type f | head -10
          
          echo "=== Running gosec JSON ==="
          gosec -fmt json -out gosec.json ./... || echo "gosec JSON exit code: $?"
          
            echo "=== Running gosec SARIF ==="
            gosec -fmt sarif -out gosec.sarif ./... || echo "gosec SARIF exit code: $?"
            
            echo "=== Checking generated files ==="
            ls -lah gosec.* || echo "No gosec files found"
            
            if [ -f gosec.sarif ]; then
              echo "✅ gosec.sarif created successfully"
              head -20 gosec.sarif
            else
              echo "❌ gosec.sarif was NOT created"
            fi

      - name: Check gosec HIGH severity
        id: gosec_check
        if: github.event_name != 'workflow_dispatch'
        continue-on-error: true  
        run: |
          HIGH_COUNT=$(jq '[.Issues[] | select(.severity=="HIGH")] | length' gosec.json)
          echo "high_count=$HIGH_COUNT" >> $GITHUB_OUTPUT
          echo "::notice::Found $HIGH_COUNT high severity issues"
          
          if [ "$HIGH_COUNT" -gt 0 ]; then
            jq -r '.Issues[] | select(.severity=="HIGH") | "::error file=\(.file),line=\(.line)::\(.rule): \(.details)"' gosec.json
            exit 1  # Mark as failed but continue workflow
          fi

      - name: Upload gosec SARIF
        if: always()  # Remove the hashFiles check temporarily
        continue-on-error: true
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: gosec.sarif
          category: gosec

      # ========================
      # GOVULNCHECK
      # ========================
      - name: Run govulncheck
        id: govulncheck
        continue-on-error: true 
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck -format sarif ./... 2>&1 | tee govulncheck.sarif
          echo "exit_code=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT

      - name: Upload govulncheck SARIF
        if: always()  # Remove the hashFiles check temporarily
        continue-on-error: true
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: govulncheck.sarif
          category: govulncheck

      # ========================
      # FINAL CHECK - Fail if any issues found
      # ========================
      - name: Final security check
        if: github.event_name != 'workflow_dispatch'
        run: |
          GOSEC_FAILED="${{ steps.gosec_check.outcome }}"
          VULN_EXIT="${{ steps.govulncheck.outputs.exit_code }}"
          
          echo "=== Security Scan Results ==="
          echo "gosec HIGH severity issues: ${{ steps.gosec_check.outputs.high_count || 0 }}"
          echo "govulncheck exit code: $VULN_EXIT"
          echo "============================"
          
          FAILED=false
          
          if [ "$GOSEC_FAILED" = "failure" ]; then
            echo "::error::gosec found HIGH severity issues"
            FAILED=true
          fi
          
          if [ "$VULN_EXIT" = "3" ]; then
            echo "::error::govulncheck found vulnerabilities"
            FAILED=true
          fi
          
          if [ "$FAILED" = "true" ]; then
            echo "::error::Security scans failed. Check the Security tab for details."
            exit 1
          fi
          
          echo "::notice::All security scans passed ✓"
